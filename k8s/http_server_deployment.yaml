apiVersion: apps/v1
kind: Deployment
metadata:
  name: http-server-deployment
  namespace: http-server
  labels:
    app: http-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: http-server
  template:
    metadata:
      labels:
        app: http-server
    spec:
      containers:
        - name: http-server
          image: tonylixu/go_http_server
          env:
            - name: HTTP_SERVER_PORT
              configMapKeyRef:
                name: http-server
                key: server_port
            - name: LOG_FILE
              configMapKeyRef:
                name: http-server
                key: log_file
          args: ["--port", "$(HTTP_SERVER_PORT)", "--log", "$(LOG_FILE)"]
          ports:
            - containerPort: 8081
          readinessProbe:
            httpGet:
              path: /healthz
              port: liveness-port
            initialDelaySeconds: 3
            periodSeconds: 3
          livenessProbe:
            exec:
              command:
                - cat
                - /tmp/live
            initialDelaySeconds: 3
            periodSeconds: 3
          startupProbe:
            httpGet:
              path: /healthz
              port: liveness-port
            # One minute startup finish
            failureThreshold: 6
            periodSeconds: 10
        restartPolicy: OnFailure
